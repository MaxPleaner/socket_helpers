<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link href='https://fonts.googleapis.com/css?family=Architects+Daughter' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <title>Socket helpers by MaxPleaner</title>
  </head>

  <body>
    <header>
      <div class="inner">
        <h1>Socket helpers</h1>
        <h2>websocket helpers for rails</h2>
        <a href="https://github.com/MaxPleaner/socket_helpers" class="button"><small>View project on</small> GitHub</a>
      </div>
    </header>

    <div id="content-wrapper">
      <div class="inner clearfix">
        <section id="main-content">
          <h1>
<a id="sockethelpers" class="anchor" href="#sockethelpers" aria-hidden="true"><span class="octicon octicon-link"></span></a>SocketHelpers</h1>

<h3>
<a id="usage-installation" class="anchor" href="#usage-installation" aria-hidden="true"><span class="octicon octicon-link"></span></a>Usage /Installation</h3>

<p><em>(these instructions can be seen implemented in the <a href="http://github.com/maxpleaner/socket_helpers_example">socket_helpers_example</a> repo</em></p>

<hr>

<h4>
<a id="1" class="anchor" href="#1" aria-hidden="true"><span class="octicon octicon-link"></span></a>1.</h4>

<p><strong>create rails app</strong> <code>rails new App; cd App;</code></p>

<hr>

<h4>
<a id="2" class="anchor" href="#2" aria-hidden="true"><span class="octicon octicon-link"></span></a>2.</h4>

<p><strong>create a model</strong> <code>rails g scaffold Todo content:string; rake db:migrate;</code></p>

<hr>

<h4>
<a id="3" class="anchor" href="#3" aria-hidden="true"><span class="octicon octicon-link"></span></a>3.</h4>

<p><strong>add gems</strong> <code>gem 'socket_helpers'</code> and <code>gem 'websocket-rails'</code></p>

<hr>

<h4>
<a id="4" class="anchor" href="#4" aria-hidden="true"><span class="octicon octicon-link"></span></a>4.</h4>

<p><strong>add javascript requires to application.js</strong></p>

<ul>
<li><code>//= require websocket_rails/main</code></li>
<li><code>//= require socket_helpers</code></li>
</ul>

<hr>

<h4>
<a id="5" class="anchor" href="#5" aria-hidden="true"><span class="octicon octicon-link"></span></a>5.</h4>

<p><strong>add jquery initializer</strong> for whatever models you need websocket resources for (singular, snake case)</p>

<div class="highlight highlight-source-js"><pre>   <span class="pl-en">$</span>(<span class="pl-k">function</span>(){
    <span class="pl-smi">SocketHelpers</span>.<span class="pl-en">initialize</span>([<span class="pl-s"><span class="pl-pds">"</span>todo<span class="pl-pds">"</span></span>])
   })</pre></div>

<hr>

<h4>
<a id="6" class="anchor" href="#6" aria-hidden="true"><span class="octicon octicon-link"></span></a>6.</h4>

<p><strong>include the controller helpers to application_controller</strong></p>

<div class="highlight highlight-source-ruby"><pre>   <span class="pl-k">class</span> <span class="pl-en">ApplicationController<span class="pl-e"> &lt; ActionController::Base</span></span>
     <span class="pl-k">include</span> <span class="pl-c1">SocketHelpers</span>::<span class="pl-c1">ControllerHelpers</span>
   <span class="pl-k">end</span></pre></div>

<hr>

<h4>
<a id="7" class="anchor" href="#7" aria-hidden="true"><span class="octicon octicon-link"></span></a>7.</h4>

<p><strong>Remove the default scaffold routes</strong> (<code>resources :todos</code>). This gem supports only query parameters, not path parameters. This limitation only applies to <code>websocket_response</code> endpoints. Other endpoints can use path parameters.</p>

<ul>
<li>i.e. parameters are never declared in the routes.rb file, but they are declared in controllers. For example, routes like <code>DELETE /todos/MY_TODO_ID</code> are not supported, but <code>DELETE /todos?id=MY_TODO_ID</code> are.</li>
</ul>

<hr>

<h4>
<a id="8" class="anchor" href="#8" aria-hidden="true"><span class="octicon octicon-link"></span></a>8.</h4>

<p><strong>Create a HTML-serving endpoint</strong> <code>rails g controller HtmlPages root</code></p>

<hr>

<h4>
<a id="9" class="anchor" href="#9" aria-hidden="true"><span class="octicon octicon-link"></span></a>9.</h4>

<p><strong>Create websocket API endpoints and write routes</strong></p>

<div class="highlight highlight-source-ruby"><pre>   <span class="pl-c"># routes.rb</span>
   get <span class="pl-s"><span class="pl-pds">"</span>/<span class="pl-pds">"</span></span>, <span class="pl-c1">to:</span> <span class="pl-s"><span class="pl-pds">"</span>html_pages#root<span class="pl-pds">"</span></span>
   post <span class="pl-s"><span class="pl-pds">"</span>todos<span class="pl-pds">"</span></span>, <span class="pl-c1">to:</span> <span class="pl-s"><span class="pl-pds">"</span>todos#create<span class="pl-pds">"</span></span>
   delete <span class="pl-s"><span class="pl-pds">"</span>todos<span class="pl-pds">"</span></span>, <span class="pl-c1">to:</span> <span class="pl-s"><span class="pl-pds">"</span>todos#destroy<span class="pl-pds">"</span></span></pre></div>

<div class="highlight highlight-source-ruby"><pre>   <span class="pl-c"># app/controllers/todos_controller.rb</span>
   <span class="pl-c"># all the default scaffold stuff can be deleted</span>
   <span class="pl-k">class</span> <span class="pl-en">TodosController<span class="pl-e"> &lt; ApplicationController</span></span>
     <span class="pl-k">def</span> <span class="pl-en">create</span>
       todo <span class="pl-k">=</span> <span class="pl-c1">Todo</span>.create(todo_params)
       websocket_response(todo, <span class="pl-s"><span class="pl-pds">"</span>create<span class="pl-pds">"</span></span>)
     <span class="pl-k">end</span>
     <span class="pl-k">def</span> <span class="pl-en">destroy</span>
       todo <span class="pl-k">=</span> <span class="pl-c1">Todo</span>.find_by(<span class="pl-c1">id:</span> params[<span class="pl-c1">:id</span>])
       todo.destroy
       websocket_response(todo, <span class="pl-s"><span class="pl-pds">"</span>destroy<span class="pl-pds">"</span></span>)
     <span class="pl-k">end</span>
     <span class="pl-k">def</span> <span class="pl-en">todo_params</span>
       params.permit(<span class="pl-c1">:content</span>)
     <span class="pl-k">end</span>
   <span class="pl-k">end</span></pre></div>

<ul>
<li>the first argument of <code>websocket_response</code> can be a single record or an array. <em>It cannot be a query</em>. The second can be either <code>create</code>, <code>destroy</code>, or <code>update</code> (these values hard-coded into the app. The receiver-hooks for these events are automatically created by the javascript client. </li>
</ul>

<hr>

<h4>
<a id="10" class="anchor" href="#10" aria-hidden="true"><span class="octicon octicon-link"></span></a>10.</h4>

<p><strong>use the DSL for HTML</strong> in html_pages/root.html.erb. See below for a list of HTML components available.</p>

<div class="highlight highlight-text-html-basic"><pre>    &lt;<span class="pl-ent">h3</span>&gt;Create todo&lt;/<span class="pl-ent">h3</span>&gt;
    &lt;<span class="pl-ent">form</span> <span class="pl-e">action</span>=<span class="pl-s"><span class="pl-pds">"</span>todos<span class="pl-pds">"</span></span> <span class="pl-e">method</span>=<span class="pl-s"><span class="pl-pds">"</span>POST<span class="pl-pds">"</span></span>&gt;
      &lt;<span class="pl-ent">input</span> <span class="pl-e">type</span>=<span class="pl-s"><span class="pl-pds">"</span>text<span class="pl-pds">"</span></span> <span class="pl-e">name</span>=<span class="pl-s"><span class="pl-pds">"</span>content<span class="pl-pds">"</span></span> <span class="pl-e">placeholder</span>=<span class="pl-s"><span class="pl-pds">"</span>content<span class="pl-pds">"</span></span>&gt;
      &lt;<span class="pl-ent">input</span> <span class="pl-e">type</span>=<span class="pl-s"><span class="pl-pds">"</span>submit<span class="pl-pds">"</span></span> <span class="pl-e">value</span>=<span class="pl-s"><span class="pl-pds">"</span>submit<span class="pl-pds">"</span></span>&gt;
    &lt;/<span class="pl-ent">form</span>&gt;
    &lt;<span class="pl-ent">div</span> <span class="pl-e">class</span>=<span class="pl-s"><span class="pl-pds">"</span>todo_index<span class="pl-pds">"</span></span>&gt;
      &lt;<span class="pl-ent">h3</span>&gt;Todos&lt;/<span class="pl-ent">h3</span>&gt;
      &lt;<span class="pl-ent">p</span> <span class="pl-e">template</span>&gt;
        &lt;<span class="pl-ent">span</span> <span class="pl-e">template-attr</span>=<span class="pl-s"><span class="pl-pds">"</span>content<span class="pl-pds">"</span></span>&gt;&lt;/<span class="pl-ent">span</span>&gt;
        &lt;<span class="pl-ent">form</span> <span class="pl-e">action</span>=<span class="pl-s"><span class="pl-pds">"</span>/todos<span class="pl-pds">"</span></span> <span class="pl-e">method</span>=<span class="pl-s"><span class="pl-pds">"</span>POST<span class="pl-pds">"</span></span>
          &lt;<span class="pl-e">input</span> <span class="pl-e">type</span>=<span class="pl-s"><span class="pl-pds">"</span>hidden<span class="pl-pds">"</span></span> <span class="pl-e">name</span>=<span class="pl-s"><span class="pl-pds">"</span>_method<span class="pl-pds">"</span></span> <span class="pl-e">value</span>=<span class="pl-s"><span class="pl-pds">"</span>DELETE<span class="pl-pds">"</span></span>
          &lt;<span class="pl-e">input</span> <span class="pl-e">type</span>=<span class="pl-s"><span class="pl-pds">"</span>hidden<span class="pl-pds">"</span></span> <span class="pl-e">name</span>=<span class="pl-s"><span class="pl-pds">"</span>id<span class="pl-pds">"</span></span> <span class="pl-e">template-attr</span>=<span class="pl-s"><span class="pl-pds">"</span>id<span class="pl-pds">"</span></span>
          &lt;<span class="pl-e">input</span> <span class="pl-e">type</span>=<span class="pl-s"><span class="pl-pds">"</span>submit<span class="pl-pds">"</span></span> <span class="pl-e">value</span>=<span class="pl-s"><span class="pl-pds">"</span>remove<span class="pl-pds">"</span></span>&gt;&lt;/<span class="pl-ent">input</span>&gt;
        &lt;/<span class="pl-ent">form</span>&gt;
        &lt;<span class="pl-ent">br</span>&gt;
      &lt;/<span class="pl-ent">p</span>&gt;
      &lt;/<span class="pl-ent">ul</span>&gt;
    &lt;/<span class="pl-ent">div</span>&gt;
    &lt;<span class="pl-ent">div</span> <span class="pl-e">init</span>=<span class="pl-s"><span class="pl-pds">"</span>todo<span class="pl-pds">"</span></span>&gt;
      &lt;%= Oj.dump [Todo.first] %&gt;
    &lt;/<span class="pl-ent">div</span>&gt;</pre></div>

<ul>
<li>This provides working 'index, 'create', and 'destroy' websocket functionality in quite few lines of HTML, which is mainly the point of this gem. 'update' is automatic as well. When a record is added to the page, a <code>record-id</code> attribute is automatically set to <code>&lt;record_class&gt;,&lt;id&gt;</code> on the newly-added template. This is used to lookup records. </li>
</ul>

<hr>

<h4>
<a id="11" class="anchor" href="#11" aria-hidden="true"><span class="octicon octicon-link"></span></a>11.</h4>

<p><strong>start rails server</strong> <code>rails s;</code>, open <a href="http://localhost:3000">localhost:3000</a></p>

<p>It is a working todo-app with websockets. Try opening two browser windows at once. </p>

<hr>

<h3>
<a id="list-of-html-components" class="anchor" href="#list-of-html-components" aria-hidden="true"><span class="octicon octicon-link"></span></a><strong>List of HTML components</strong>
</h3>

<ul>
<li><p>elements with a class of <code>&lt;model_name&gt;-index</code> become lists, with elements auto-removed and added in response to websocket events. For example, <code>&lt;div class="todo-index"&gt;&lt;/div&gt;</code>. These sections correspond to a single ActiveRecord class (underscore, singular i.e. <code>todo_list_item</code> for <code>TodoListItem</code>)</p></li>
<li><p>inside a <code>&lt;model_name&gt;-index</code> element, an element with a <code>template</code> attribute becomes the template for added records. For example, <code>&lt;div template&gt;&lt;/div&gt;</code></p></li>
<li><p>inside a <code>[template]</code> element, the <code>template-attr</code> attribute is used to establish two-way databinding on an element. Its value is the name of the attribute. This can be used to set the value of form inputs or to change text nodes. For example, <code>&lt;input type="text" name="content" template-attr="content"&gt;</code> or <code>&lt;span template-attr="content"&gt;</code></p></li>
<li><p><strong>all form submits are intercepted</strong> by event listeners by default. To override this, add the "skip-sockets" attribute to the form element. They submit AJAX requests using the url in the form's <code>action</code> attribute and the method in the form's <code>method</code> attribute (i.e. <code>action="/todos" method="POST"</code>). This works for <code>GET</code> and <code>POST</code> only, but <code>PUT</code> and <code>DELETE</code> can be used by adding a hidden input method i.e. <code>input type="hidden" name="_method" value="PUT"</code>. This is the default Rails behavior anyway.</p></li>
<li><p>To submit an id with a form, bind a hidden attribute i.e. <code>&lt;input type="hidden" name="id" template-attr='id'&gt;</code></p></li>
<li><p>Outside of <code>[template]</code>s, binding tags are a bit more verbose. <code>&lt;span binding-tag='todos,1,content'&gt;&lt;/span&gt;</code> where the three comma-separated arguments are <code>&lt;model_class&gt;</code>, <code>&lt;id&gt;</code>, and <code>&lt;attribute&gt;</code>. <code>template-attr</code> tags are automatically converted to <code>binding-tag</code> once new records are added to the page. </p></li>
</ul>

<hr>

<h3>
<a id="loading-initial-data-on-the-page" class="anchor" href="#loading-initial-data-on-the-page" aria-hidden="true"><span class="octicon octicon-link"></span></a><strong>Loading initial data on the page</strong>
</h3>

<p>Without doing this, the page will be empty every time it is refreshed. The page needs to start out with a list of records loaded.</p>

<p>Create an html element with an <code>init</code> attribute set to a model class, i.e. <code>todo</code>. This element will be auto-hidden. In the html-serving controller method, make an instance variable for whatever data is going to be included (expects an array, not a single object or query). On the html page, use ERB to set the content of the <code>[init]</code> element to a JSON stringified version of your instance variable. For example, <code>&lt;div init="todo"&gt;&lt;%= Oj.dump([User.first]) %&gt;&lt;/div&gt;</code></p>

<hr>

<h3>
<a id="additional-helpers" class="anchor" href="#additional-helpers" aria-hidden="true"><span class="octicon octicon-link"></span></a><strong>Additional Helpers</strong>
</h3>

<p>you can make one html element toggle another open / close very easily.</p>

<p>Just make them 'siblings (share the same parent element) and give the trigger a <code>toggles</code> attribute with a value set to the CSS selector of the target. The target will be initially closed. </p>

<hr>

<h3>
<a id="caveats" class="anchor" href="#caveats" aria-hidden="true"><span class="octicon octicon-link"></span></a><strong>Caveats</strong>
</h3>

<ul>
<li>I use the OJ gem here and <code>Oj.dump</code> because of a recursion bug in <code>to_json</code>. I'm still not sure what the cause is, perhaps a naming conflict somewhere. Also, <code>Oj.dump</code> only works with single elements / arrays, not active record queries i.e. <code>Oj.dump Todo.all.limit(5)</code> wouldnt work</li>
</ul>
        </section>

        <aside id="sidebar">
          <a href="https://github.com/MaxPleaner/socket_helpers/zipball/master" class="button">
            <small>Download</small>
            .zip file
          </a>
          <a href="https://github.com/MaxPleaner/socket_helpers/tarball/master" class="button">
            <small>Download</small>
            .tar.gz file
          </a>

          <p class="repo-owner"><a href="https://github.com/MaxPleaner/socket_helpers"></a> is maintained by <a href="https://github.com/MaxPleaner">MaxPleaner</a>.</p>

          <p>This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the Architect theme by <a href="https://twitter.com/jasonlong">Jason Long</a>.</p>
        </aside>
      </div>
    </div>

  
  </body>
</html>
